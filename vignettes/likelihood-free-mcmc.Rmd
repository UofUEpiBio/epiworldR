---
title: "Likelihood Free Markhov Chain Monte Carlo (LFMCMC)"
author:
  - Andrew Pulsipher
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{LFMCMC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", out.width = "80%", fig.width = 7, fig.height = 5,
  fig.align = "center"
)
```
# Introduction
The purpose of the "lfmcmc" function is to perform a Likelihood-Free Markhov Chain Monte Carlo simulation.

# Example: Using LFMCMC to calibrate SIR Model

## Setup and Running Model
Create an SIR Model and add a small world population.
```{r sir-setup}
library(epiworldR)

model_seed <- 122

model_sir <- ModelSIR(
  name = "COVID-19",
  prevalence = .1,
  transmission_rate = .1,
  recovery_rate = .3
)

agents_smallworld(
  model_sir,
  n = 1000,
  k = 5,
  d = FALSE,
  p = 0.01
)

verbose_off(model_sir)

run(
  model_sir,
  ndays = 50,
  seed = model_seed
)

print(model_sir)
```

## Extract Observed data
```{r extract-obs-data}
obs_data <- get_today_total(model_sir)
```

## Setup LFMCMC
```{r lfmcmc-setup}
# Define Simulation Function
simfun <- function(params, m) {
  set_param(model_sir, "Recovery Rate", params[0])
  set_param(model_sir, "Transmission Rate", params[1])
  reset(model_sir)
  run(
    model_sir,
    ndays = 50,
    seed = model_seed
  )
  res <- get_today_total(model_sir)
  return(res)
}
# TODO: Define Summary Function
sumfun <- function(res, dat, m) {
  # if (length(res) == 0)
  #     res.resize(data.size())

  # for (i in dat.size())
  #     res[i] = static_cast<float>(dat[i])

  return
}
# TODO: Define Proposal Function
propfun <- function(params_now, params_prev, m) {
  return
}
# TODO: Define Kernel Function
kernfun <- function() {
  return(1.0)
}

# Set initial parameters
par0 <- c(.5, .5)
```

## Run LFMCMC
```{r lfmcmc-run}
# TODO: make these work
lfmcmc_model <- LFMCMC() |>
  set_simulation_fun(simfun) |>
  set_summary_fun(sumfun) |>
  set_proposal_fun(propfun) |>
  set_kernel_fun(kernfun)
#   set_observed_data(obs_dat) |>
#   run_lfmcmc(par0, 2000, 1)

# lfmcmc_model

# lfmcmc_model <- seed(lfmcmc_model, model_seed) |>
#   set_par_names(c("Immune recovery", "Infectiousness")) |>
#   set_stats_names(get_states(model_sir)) |>
#   print()
```
