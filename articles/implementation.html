<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Implementation details of epiworldR • epiworldR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Implementation details of epiworldR">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epiworldR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5-0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting started with epiworldR</a></li>
    <li><a class="dropdown-item" href="../articles/implementation.html">Implementation details of epiworldR</a></li>
    <li><a class="dropdown-item" href="../articles/likelihood-free-mcmc.html">Likelihood Free Markhov Chain Monte Carlo (LFMCMC)</a></li>
    <li><a class="dropdown-item" href="../articles/mixing.html">Mixing models</a></li>
    <li><a class="dropdown-item" href="../articles/run-multiple.html">Run Multiple</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UofUEpiBio/epiworldR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Implementation details of epiworldR</h1>
                        <h4 data-toc-skip class="author">George Vega
Yon</h4>
                        <h4 data-toc-skip class="author">Derek
Meyer</h4>
            
            <h4 data-toc-skip class="date">2023-06-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/UofUEpiBio/epiworldR/blob/main/vignettes/implementation.Rmd" class="external-link"><code>vignettes/implementation.Rmd</code></a></small>
      <div class="d-none name"><code>implementation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The following vignette provides detailed information about the
implementation of <code>epiworldR</code>. The package is a wrapper of
the C++ package <code>epiworld</code>, a framework for building
agent-based models.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The C++ package is available at &lt;a href="https://github.com/UofUEpiBio/epiworld" class="external-link"&gt;https://github.com/UofUEpiBio/epiworld&lt;/a&gt;.&lt;/p&gt;'><sup>1</sup></a></p>
</div>
<div class="section level2">
<h2 id="general-flow-of-the-models">General flow of the models<a class="anchor" aria-label="anchor" href="#general-flow-of-the-models"></a>
</h2>
<p>The core function of <code>epiworldR</code> is the <code><a href="../reference/epiworld-methods.html">run()</a></code>
function. This function executes the model and saves the results in a
database part of the underlying C++ object. The package implements a
discrete-time ABM, meaning the model is executed in discrete steps
(<em>e.g.</em>, days). The <code><a href="../reference/epiworld-methods.html">run()</a></code> function executes the
following steps:</p>
<ol style="list-style-type: decimal">
<li>The model is <code>reset()</code>, which involves: (a) resetting the
agents, or if available, restoring the population backup<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Population backups are created on the fly the first time
the model is run. Generally, backups are relevant for undoing changes in
the network structure. Although &lt;code&gt;epiworld&lt;/code&gt; (C++) provides a
way to change network structure, the current version of
&lt;code&gt;epiworldR&lt;/code&gt; does not.&lt;/p&gt;"><sup>2</sup></a>, (b) resetting the
database, (c) distributing viruses and tools, (d) and setting the
initial state of agents. All these steps fixing
<code>current_date = 0</code>.</li>
</ol>
<ol start="3" style="list-style-type: decimal">
<li><p>The model’s state is recorded in the database, and the
<code>current_date</code> is incremented by 1.</p></li>
<li>
<p>After resetting the model, we start an iterative process
repeating the following steps:</p>
<ol style="list-style-type: lower-alpha">
<li>
<p>The state of each agent is updated. States are updated according
to their corresponding <code>update_state</code> function.</p>
<p>Since the model is discrete-time, <strong>state changes are stored as
promises</strong>, meaning that agents’ states are not updated
immediately. Instead, the state is updated at the end of the updates.
This is done to avoid updating the state of an agent and then using the
updated state to update the state of another agent. For example, if
agent
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
infects agent
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
then agent
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
should not be able to infect agent
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
in the same step.</p>
</li>
<li><p>Once the update schedule is laid out, the changes are made
effective, so, for instance, individuals who became infected during the
update will start the next step in the infected state.</p></li>
<li><p>Global actions are executed. These could also change agents’
states, so just like in the previous step, these changes are stored as
promises and made effective once all actions have been
evaluated.</p></li>
<li><p>The model’s state is recorded in the database, and the
<code>current_date</code> is incremented by 1.</p></li>
<li><p>The model checks whether the simulation should stop. If the
simulation should stop, the model stops. Otherwise, the model goes back
to step a.</p></li>
</ol>
</li>
</ol>
<p>Other steps included in <code>epiworld</code> but not in
<code>epiworldR</code> are the network rewiring and mutation of viruses.
These will be implemented in future versions of
<code>epiworldR</code>.</p>
</div>
<div class="section level2">
<h2 id="computing-probabilities">Computing probabilities<a class="anchor" aria-label="anchor" href="#computing-probabilities"></a>
</h2>
<div class="section level3">
<h3 id="transmission-probability">Transmission probability<a class="anchor" aria-label="anchor" href="#transmission-probability"></a>
</h3>
<p>Generally, <code>epiworldR</code> assumes that at each step of the
simulation, susceptible agents can acquire the disease from at most one
infected agent. The probability of transmission from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
is given by the following formula:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>→</mo><mi>j</mi><mo stretchy="false" form="prefix">|</mo><mtext mathvariant="normal">at most one</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>×</mo><munder><mo>∏</mo><mrow><mi>k</mi><mo>≠</mo><mi>i</mi></mrow></munder><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mrow><mi>k</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><munder><mo>∏</mo><mi>k</mi></munder><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mrow><mi>k</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><munder><mo>∑</mo><mi>k</mi></munder><msub><mi>p</mi><mrow><mi>k</mi><mi>j</mi></mrow></msub><mo>×</mo><munder><mo>∏</mo><mrow><mi>l</mi><mo>≠</mo><mi>k</mi></mrow></munder><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mrow><mi>l</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">
P(i\to j| \mbox{at most one}) = \frac{p_{ij} \times \prod_{k\neq i}\left(1 - p_{kj}\right)}{\prod_k\left(1 - p_{kj}\right) + \sum_k p_{kj} \times \prod_{l\neq k}\left(1 - p_{lj}\right)}
</annotation></semantics></math></p>
<p>The adjusted probabilities
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">p_{ij}</annotation></semantics></math>
are computed as a function of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
and the virus. The following section describes how these probabilities
are computed.</p>
</div>
<div class="section level3">
<h3 id="adjusted-probabilities">Adjusted probabilities<a class="anchor" aria-label="anchor" href="#adjusted-probabilities"></a>
</h3>
<p>Viruses and tools provide a way to adjust how agents move between
states. Viruses in <code>epiworldR</code> contain various baseline
probabilities used across models, including transmission, recovery, and
death. On the other hand, tools alter these probabilities by
reducing/increasing them. Furthermore, tools alter agents’
susceptibility, infectiousness, recovery, and death probabilities.
Currently, tools alter these probabilities by a constant factor,</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>p</mi><mi>v</mi></msub><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><msub><mi>r</mi><mrow><mi>h</mi><mi>o</mi><mi>s</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><msub><mi>r</mi><mrow><mi>t</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p_{ij} = p_{v} \times \left(1 - factor_{host}\right) \times \left(1 - factor_{target}\right)
</annotation></semantics></math></p>
<p>Where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>v</mi></msub><annotation encoding="application/x-tex">p_{v}</annotation></semantics></math>
is the raw transmission probability of the virus
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>v</mi><annotation encoding="application/x-tex">v</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">factor_{t}</annotation></semantics></math>
are the increasing/reducing factors tools have over the process. For
example, if <code>p_v</code> was 0.9, the host was wearing a mask, so
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><msub><mi>r</mi><mtext mathvariant="normal">mask host</mtext></msub><mo>=</mo><mn>0.3</mn></mrow><annotation encoding="application/x-tex">factor_{\mbox{mask host}} = 0.3</annotation></semantics></math>
and the target was vaccinated, so
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><msub><mi>r</mi><mtext mathvariant="normal">vaccinated target</mtext></msub><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">factor_{\mbox{vaccinated target}} = 0.5</annotation></semantics></math>,
then the adjusted probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">p_{ij}</annotation></semantics></math>
would be
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.9</mn><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mn>0.3</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mn>0.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0.27</mn></mrow><annotation encoding="application/x-tex">0.9 \times (1 - 0.3) \times (1 - 0.5) = 0.27</annotation></semantics></math>.</p>
<p>When agents have more than one tool, factors are combined as
follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><msub><mi>r</mi><mrow><mi>a</mi><mi>g</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>1</mn><mo>−</mo><munder><mo>∏</mo><mrow><mi>t</mi><mo>∈</mo><mi>t</mi><mi>o</mi><mi>o</mi><mi>l</mi><msub><mi>s</mi><mrow><mi>a</mi><mi>g</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow></munder><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>f</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><msub><mi>r</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
factor_{agent} = 1 - \prod_{t\in tools_{agent}}\left(1 - factor_{t}\right)
</annotation></semantics></math></p>
<p>Therefore, for example, a vaccinated agent wearing a mask would have
a factor of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mn>0.30</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>×</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mn>0.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0.65</mn></mrow><annotation encoding="application/x-tex">1 - (1 - 0.30) \times (1 - 0.5) = 0.65</annotation></semantics></math>.
The adjusted probabilities principle also applies to recovery rates in
the SIR and SEIR models.</p>
</div>
<div class="section level3">
<h3 id="transmission-in-connected-modelsmodels">Transmission in connected models<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;The following section applies to the
&lt;code&gt;ModelSIRCONN&lt;/code&gt; and &lt;code&gt;ModelSEIRCONN&lt;/code&gt; models. The
&lt;code&gt;ModelSIR&lt;/code&gt; and &lt;code&gt;ModelSEIR&lt;/code&gt; models are similar but
do not use a connected network.&lt;/p&gt;"><sup>3</sup></a><a class="anchor" aria-label="anchor" href="#transmission-in-connected-modelsmodels"></a>
</h3>
<p>The “connected” models provide a version where agents live in a fully
connected network. This means that each agent can infect any other
agent, making this version similar to typical compartmental models. In
these models, the transmission probability depends on the contact rate.
For each susceptible agent, the transmission process is simulated as
follows:</p>
<ol style="list-style-type: decimal">
<li><p>The number of contacts
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
is drawn from a binomial distribution with parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is the number of agents and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">p =</annotation></semantics></math><code>contact_rate</code><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>/</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">/ n</annotation></semantics></math>.</p></li>
<li><p>Then,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
agents are randomly selected from the population. Transmission can then
occur from any of these agents to the susceptible agent.</p></li>
<li><p>The probability of transmission from each of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math>
agents is calculated as described in the previous section.</p></li>
</ol>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by George Vega Yon, Derek Meyer, Andrew Pulsipher, Centers for Disease Control and Prevention.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
